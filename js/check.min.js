/*!
 * Cirquity - Cirquity v0.1.0 (https://cirquity.com)
 * Copyright 2020-2020 The Cirquity Developers
 * Licensed under MIT (https://github.com/cirquity/cirquity-website/blob/master/LICENSE)
 */

!function(e){let t,r=e("#transaction-hash"),n=e("#private-key"),a=e("#public-address"),l=e("#txn-link"),o=e("#outputs-rows");e((function(){currentPage="check";let t=setInterval((function(){appReady&&clearInterval(t)}),10);e("#check-transaction").click((function(){e.getTxn(r.val(),(function(t){if(t.error)alert(t.error.message);else{const i="view",s=e.checkTxn(t.result,n.val(),a.val(),i);if(s.error)l.attr("href",""),l.html("?"),alert(s.error);else{l.attr("href","transaction.html?hash="+r.val()),l.html(r.val()),o.html("");for(let e in s.owned){let t=s.owned[e],r="<tr><td>"+t[2]+"</td><td>"+t[1]+"</td></tr>";o.append(r)}}}}))}))})),e.getTxn=function(r,n){t&&t.abort(),t=e.ajax({url:api+"/json_rpc",method:"POST",data:JSON.stringify({jsonrpc:"2.0",id:"blockexplorer",method:"f_transaction_json",params:{hash:r}}),dataType:"json",error:function(e){alert(e.error)},success:n})},e.checkTxn=function(t,r,n,a){let l=t.tx,o=t.txDetails,i=cnBase58.decode(n),s=o.hash,c={error:!1,total_owned:0,owned:[],unowned:[]};if(64!==r.length||!0!==e.validHex(r))c.error="Invalid private key.";else if(99!==n.length||i.slice(-8)!==cn_fast_hash(i.slice(0,-8)).slice(0,8))c.error="Bad address";else if("view"===a&&i.slice(72,136)!==sec_key_to_pub(r))c.error="Secret View key does not match address.";else if(64===s.length&&e.validHex(s)){let t=i.slice(72,136);if("view"===a&&(t=e.pubKeyFromExtra(l.extra)),t){let e=cnUtil.generate_key_derivation(t,r),n=i.slice(8,72);for(let t=0;t<l.vout.length;t++){let r=cnUtil.derive_public_key(e,t,n),a=l.vout[t].amount/1e8;r===l.vout[t].target.data.key?(c.total_owned+=a,c.owned.push([t,r,a])):c.unowned.push([t,l.vout[t].target.key,a])}}else c.error="Unrecognized tx_extra format!"}else c.error="Invalid TXN Hash";return c},e.pubKeyFromExtra=function(e){let t=!1;for(;e.length>0&&0===e[0];)e=e.slice(1,e.length);return 1===e[0]&&e.length>=65&&(t=e.slice(1,65)),t}}(jQuery);